<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>MusicToy — PANIC (inline)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{color-scheme:light dark}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:2rem;line-height:1.4}
    button{padding:.55rem .9rem;border-radius:.6rem;border:1px solid #999;cursor:pointer}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0 1rem}
    pre{background:#f5f5f5;color:#222;padding:.75rem;border-radius:.6rem;overflow:auto}
    code{background:#efefef;padding:0 .25rem;border-radius:.25rem}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <h1>MusicToy — Panic Loader (inline)</h1>
  <p>This page contains <strong>inline</strong> guard code (no external scripts), so it should load even if your server mis-serves MIME types.</p>

  <h3>Controls</h3>
  <div class="row">
    <button id="btn-flags">Set safe flags</button>
    <button id="btn-boot">Boot bouncers (safe)</button>
    <button id="btn-clear">Clear logs</button>
  </div>
  <div id="log" class="muted">Logs will appear here. Open DevTools for more details.</div>

  <script>
  // === Inline PANIC GUARD ===
  // Keep logs minimal
  window.BOUNCER_DBG_LEVEL = 1;
  // Silence init warnings
  window.BOUNCER_NO_INIT_WARN = true;
  // Do not autorun any bouncer boot helpers
  window.BOUNCER_NO_AUTORUN = true;

  // Throttle runaway RAF storms so page stays responsive
  (function(){
    let rafCount = 0, capped = false;
    const origRAF = window.requestAnimationFrame;
    window.requestAnimationFrame = function(cb){
      if (!capped && ++rafCount > 5000){
        capped = true;
        console.warn('[panic-guard] Excessive RAF detected; throttling.');
        return setTimeout(()=>cb(performance.now()), 16);
      }
      return origRAF.call(this, cb);
    };
  })();
  </script>

  <script type="module">
  // === Inline SAFE boot helper (no autorun) ===
  const DBG = (window.BOUNCER_DBG_LEVEL|0);
  const NO_WARN = !!window.BOUNCER_NO_INIT_WARN;
  const warned = new Set();

  function ready(){
    if (typeof window.__AUDIO_READY === 'boolean' && !window.__AUDIO_READY) return false;
    if (typeof window.__THEME_READY === 'boolean' && !window.__THEME_READY) return false;
    return true;
  }

  async function waitUntilReady(maxFrames=180){
    let i=0;
    while(!ready() && i<maxFrames){
      await new Promise(r=>requestAnimationFrame(r));
      i++;
    }
  }

  async function defaultBootSingle(toyId, el){
    if (window.Bouncer && typeof window.Bouncer.boot === 'function'){
      return window.Bouncer.boot(toyId, el);
    }
    if (typeof window.bootSingleBouncer === 'function'){
      return window.bootSingleBouncer(toyId, el);
    }
    // nothing to do if your boot is named differently
  }

  async function bootBouncersSafe(toyIds){
    await waitUntilReady();
    const ids = Array.isArray(toyIds) && toyIds.length ? toyIds : (window.BOUNCER_TOY_IDS || ["toy-b1","toy-b2"]);
    for (const toyId of ids){
      const el = document.getElementById(toyId) || document.querySelector(`[data-toy-id="${toyId}"]`);
      if (!el){
        if (DBG>=3) console.debug('[bouncer-init] skip (no DOM)', toyId);
        continue;
      }
      try {
        await defaultBootSingle(toyId, el);
      } catch (e){
        if (DBG>=2 && !NO_WARN && !warned.has(toyId)){
          console.warn('[bouncer-init] failed', toyId, e && (e.message || e));
          warned.add(toyId);
        }
      }
    }
  }
  window.bootBouncersSafe = bootBouncersSafe;

  // Tiny UI helpers
  const logNode = document.getElementById('log');
  function log(msg){
    console.log(msg);
    logNode.textContent = String(msg);
  }
  document.getElementById('btn-flags').onclick = ()=>{
    window.BOUNCER_DBG_LEVEL = 1;
    window.BOUNCER_NO_INIT_WARN = true;
    window.BOUNCER_NO_AUTORUN = true;
    log('Safe flags applied.');
  };
  document.getElementById('btn-boot').onclick = async ()=>{
    try{
      await window.bootBouncersSafe();
      log('bootBouncersSafe() called.');
    }catch(e){
      log('bootBouncersSafe() error: '+(e && (e.message || e)));
    }
  };
  document.getElementById('btn-clear').onclick = ()=>{
    logNode.textContent = '';
    console.clear();
  };
  </script>

  <p class="muted">If this page loads, but your normal page doesn't, the culprit is likely an autorun loop or a missing/404 script that the server returns as HTML (wrong MIME). Inline scripts avoid that. Fix by correcting paths or inlining guards at the top of your main page.</p>
</body>
</html>
